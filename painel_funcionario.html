<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Funcionário - Versão Móvel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 0;
            box-shadow: none;
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            background: #FF7700;
            padding: 5px;
            border-radius: 0;
        }
.logout-button {
    background: #E60000; /* Cor vermelha para destacar */
    color: white;
    border: none;
    padding: 8px 15px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 5px;
    margin-left: 10px; /* Distância do último botão */
}
.logout-button:hover {
    background: #CC0000; /* Cor mais escura ao passar o mouse */
}
        .tab {
            flex: 1;
            padding: 8px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        .tab.active {
            background: #E65C00;
        }
        .aba {
            display: none;
            padding: 10px;
        }
        .form-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
	    gap: 5px;
        }
        .form-group label {
            width: 30%;
            font-weight: bold;
            min-width: 150px;
            text-align: right;
            margin-right: 10px;
        }
        .form-group input, .form-group select {
            flex: 2;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            min-width: 200px;
        }
        .full-width {
            width: 100%;
        }
        .button {
            background: #FF7700;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 10px;
        }
        .button:hover {
            background: #E65C00;
        }
        input[type="url"] {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        #campoLink {
            display: flex;
            align-items: center;
            width: 100%;
            gap: 10px; /* Adiciona espaço entre o campo e o botão */
            flex-wrap: wrap;
        }
        #linkLocalizacao {
            flex: 3;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 12px;
        }
        #campoLink .button {
            flex: 1;
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
        }
        .servico-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px auto; /* Centraliza os itens */
            border-radius: 5px;
            background: #f9f9f9;
            text-align: left;
            position: relative;
            width: 90%; /* Limita a largura e centraliza */
        }
        .servico-item.hoje {
            border: 2px solid #FF7700;
            background: #fff5e6;
        }
        .tecnico-section {
            margin: 10px 0;
        }
        .tecnico-section h3 {
            background: #FF7700;
            color: white;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .filtro-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            gap: 5px;
        }
        .filtro-group select, .filtro-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            font-size: 14px;
        }
        .filtro-buttons {
            display: flex;
            gap: 5px;
        }
        .remove-button, .edit-button {
            background: #E65C00;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .remove-button:hover, .edit-button:hover {
            background: #FF7700;
        }
        .servico-item .buttons {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .localizacao {
            color: #0066cc;
            text-decoration: underline;
            cursor: pointer;
            font-size: 12px;
        }
        @media (min-width: 600px) {
            .container {
                width: 80%;
                max-width: 800px;
            }
            .form-group {
                flex-direction: row;
                align-items: center;
            }
            .form-group label {
                width: 150px;
                text-align: right;
                margin-right: 10px;
            }
            .filtro-group {
                flex-direction: row;
            }
            .filtro-group select, .filtro-group input {
                width: 23%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="mostrarAba('agenda')">Adicionar Serviço</div>
            <div class="tab" onclick="mostrarAba('ativos')">Serviços Ativos</div>
            <div class="tab" onclick="mostrarAba('realizados')">Agendamentos Realizados</div>
	    <button class="logout-button" onclick="logout()">Sair</button>
        </div>

        <div id="agenda" class="aba">
            <h2 id="tituloAgenda">Adicionar Novo Serviço</h2>

            <div class="form-group">
                <label>Filtro de Veículo:</label>
                <input type="text" id="filtroVeiculo" placeholder="Digite nome, placa ou cliente" oninput="filtrarVeiculos()">
            </div>
            <div class="form-group">
                <label>Veículo (API):</label>
                <select id="veiculoAPI" onchange="preencherDadosVeiculo()">
                    <option value="">Selecione um veículo</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tipo de Serviço:</label>
                <select id="tipoServico">
                    <option value="">Selecione</option>
                    <option value="Instalação">Instalação</option>
                    <option value="Manutenção">Manutenção</option>
                    <option value="Retirada">Retirada</option>
                    <option value="Reinstalação">Reinstalação</option>
                    <option value="Entrega de Carnê">Entrega de Carnê</option>
                    <option value="Passar o Cartão">Passar o Cartão</option>
                </select>
                <label>Empresa:</label>
                <select id="empresa" onchange="carregarVeiculosPorBase()">
                    <option value="">Selecione</option>
                    <option value="https://jc.rastrosystem.com.br">JC Horizonte</option>
                    <option value="https://jccarfortaleza.rastrosystem.com.br">JC Fortaleza</option>
                    <option value="https://rastremax.rastrosystem.com.br">Rastremax</option>
                    <option value="https://jc.sistemsatservicos.com.br">Defend</option>
                </select>
            </div>

            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="data">
                <label>Horário:</label>
                <select id="horario">
                    <option value="">Selecione um horário</option>
                    <option value="08:00">08:00</option>
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                </select>
            </div>

            <div class="form-group">
                <label>Técnico Responsável:</label>
                <select id="tecnico">
                    <option value="">Selecione</option>
                    <option value="Bruno">Bruno</option>
                    <option value="Cleber">Cleber</option>
                    <option value="Romario">Romario</option>
                </select>
                <label>Status:</label>
                <select id="status">
                    <option value="Pendente">Pendente</option>
                    <option value="Concluído">Concluído</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>

            <div class="form-group">
                <label>Nome do Cliente:</label>
                <input type="text" id="cliente" placeholder="Nome e Sobrenome">
                <label>Telefone:</label>
                <input type="text" id="telefone" placeholder="(99) 99999-9999" oninput="formatarTelefone(this)">
            </div>

            <div class="form-group">
                <label>Endereço:</label>
                <select id="tipoEndereco" onchange="alternarEndereco()">
                    <option value="">Selecione uma opção</option>
                    <option value="digitado">Endereço Digitado</option>
                    <option value="link">Localização via Link</option>
                </select>
            </div>

            <div id="campoEndereco" style="display: none;">
                <div class="form-group">
                    <label>Rua:</label>
                    <input type="text" id="rua" placeholder="Rua">
                    <label>Número:</label>
                    <input type="text" id="numero" placeholder="Número">
                </div>
                <div class="form-group">
                    <label>Bairro:</label>
                    <input type="text" id="bairro" placeholder="Bairro">
                    <label>Cidade:</label>
                    <input type="text" id="cidade" placeholder="Cidade">
                </div>
                <div class="form-group">
                    <label>Condomínio?</label>
                    <select id="ehCondominio" onchange="toggleCondominio()">
                        <option value="">Selecione</option>
                        <option value="nao">Não</option>
                        <option value="sim">Sim</option>
                    </select>
                </div>
                <div class="form-group" id="campoCondominio" style="display: none;">
                    <label>Bloco:</label>
                    <input type="text" id="bloco" placeholder="Bloco">
                    <label>Apartamento:</label>
                    <input type="text" id="apartamento" placeholder="Apartamento">
                </div>
            </div>

            <div class="form-group" id="campoLink" style="display: none; align-items: center;">
                <label for="linkLocalizacao" style="flex: 0 0 200px; text-align: right;">Localização via Link:</label>
                <input type="url" id="linkLocalizacao" class="full-width" placeholder="Localização do veículo" readonly>
                <button class="button" onclick="abrirGoogleMaps()">Abrir no Google Maps</button>
            </div>

            <div class="form-group">
                <label>Modelo do Veículo:</label>
                <input type="text" id="modelo">
                <label>Ano do Veículo:</label>
                <input type="text" id="ano">
                <label>Placa (Opcional):</label>
                <input type="text" id="placa">
            </div>

            <div class="form-group">
                <label>Observações:</label>
                <input type="text" id="observacoes" class="full-width">
            </div>

            <div class="form-group">
                <label>Valor a Receber:</label>
                <input type="number" id="valorReceber" placeholder="R$ 0,00">
            </div>

            <button class="button" id="botaoAcao" onclick="adicionarServico()">Adicionar Serviço</button>
        </div>

        <div id="ativos" class="aba" style="display: none;">
            <h2>Serviços do Dia</h2>
            <div id="listaServicosAtivos"></div>
            <button class="button" onclick="atualizarServicosAtivos()">Atualizar Serviços</button>
        </div>

        <div id="realizados" class="aba" style="display: none;">
            <h2>Agendamentos Realizados</h2>
            <div class="filtro-group">
                <select id="filtroTecnico">
                    <option value="">Todos os Técnicos</option>
                    <option value="Bruno">Bruno</option>
                    <option value="Cleber">Cleber</option>
                    <option value="Romario">Romario</option>
                </select>
                <input type="date" id="filtroData" placeholder="Filtrar por Data">
                <select id="filtroTipoServico">
                    <option value="">Todos os Tipos</option>
                    <option value="Instalação">Instalação</option>
                    <option value="Manutenção">Manutenção</option>
                    <option value="Retirada">Retirada</option>
                    <option value="Reinstalação">Reinstalação</option>
                    <option value="Entrega de Carnê">Entrega de Carnê</option>
                    <option value="Passar o Cartão">Passar o Cartão</option>
                </select>
                <select id="filtroStatus">
                    <option value="">Todos os Status</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Concluído">Concluído</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
            <div class="filtro-group">
                <input type="text" id="filtroCliente" placeholder="Buscar por Nome do Cliente" style="width: 100%;">
            </div>
            <div class="filtro-buttons">
                <button class="button" onclick="aplicarFiltros()">Filtrar</button>
                <button class="button" onclick="limparFiltros()">Limpar Filtros</button>
            </div>
            <div id="listaServicos"></div>
        </div>
    </div>

    <script>
        let editIndex = null;
        const dataAtual = "2025-03-12"; // Atualizado para hoje
        let todosVeiculos = [];
        let intervalId = null;

        const tokensPorBase = {
            "https://jc.rastrosystem.com.br": "265f94ae4347d0dca9bdd936e6be93536540cf88",
            "https://rastremax.rastrosystem.com.br": "532285f1415c760f0bca96b2a1673618091dcff0",
            "https://jccarfortaleza.rastrosystem.com.br": "fd329f6923befecf8b12f5258d0da457e1a7fad9",
            "https://jc.sistemsatservicos.com.br": "87b97b1f1080839159279ff34154603d78918f5a"
        };

        function normalizarNome(nome) {
            if (!nome) return "";
            return nome
                .toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function obterLocalizacao(veiculo) {
            if (!veiculo.eqp_id || !veiculo.gps_fixed) {
                return "Localização indisponível (equipamento não ativo ou GPS não fixado)";
            }

            if (veiculo.latitude && veiculo.longitude) {
                return `https://www.google.com/maps?q=${veiculo.latitude},${veiculo.longitude}`;
            } else if (veiculo.address) {
                return `https://www.google.com/maps?q=${encodeURIComponent(veiculo.address)}`;
            } else {
                return "Localização indisponível (sem coordenadas ou endereço)";
            }
        }

        function abrirGoogleMaps() {
            const link = document.getElementById("linkLocalizacao").value;
            if (link && link.startsWith("http")) {
                window.open(link, "_blank");
            } else {
                alert("Nenhum link de localização válido disponível.");
            }
        }

        async function carregarVeiculosPorBase() {
            const baseUrl = document.getElementById("empresa").value;
            if (!baseUrl) {
                todosVeiculos = [];
                preencherDropdownVeiculos([]);
                document.getElementById("campoLink").style.display = "none";
                return;
            }

            const token = tokensPorBase[baseUrl];
            if (!token) {
                alert("Token não configurado para esta base.");
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/api_v2/veiculos-v3/`, {
                    method: "GET",
                    headers: {
                        "Authorization": `token ${token}`
                    }
                });
                if (!response.ok) {
                    console.error("Erro na requisição:", response.status, response.statusText);
                    alert("Erro ao carregar veículos da base selecionada. Verifique o console.");
                    return;
                }
                const data = await response.json();
                console.log("Resposta da API para", baseUrl, ":", JSON.stringify(data, null, 2));

                todosVeiculos = data.dispositivos || [];
                if (!todosVeiculos || todosVeiculos.length === 0) {
                    console.error("Nenhum veículo encontrado em 'dispositivos' para", baseUrl);
                    alert("Nenhum veículo encontrado nesta base.");
                    preencherDropdownVeiculos([]);
                    document.getElementById("campoLink").style.display = "none";
                    return;
                }

                preencherDropdownVeiculos(todosVeiculos);
            } catch (error) {
                console.error("Erro ao carregar veículos:", error);
                alert("Erro ao conectar com a API da base selecionada.");
            }
        }

        function preencherDropdownVeiculos(veiculos) {
            const selectVeiculo = document.getElementById("veiculoAPI");
            selectVeiculo.innerHTML = '<option value="">Selecione um veículo</option>';

            veiculos.forEach(veiculo => {
                const option = document.createElement("option");
                option.value = veiculo.eqp_id || veiculo.id || "";
                option.text = `${veiculo.name || veiculo.veiculo_modelo || "Veículo sem nome"} (${veiculo.placa || "Sem placa"}) - ${veiculo.cliente || "Sem cliente"}`;
                option.dataset.dados = JSON.stringify(veiculo);
                selectVeiculo.appendChild(option);
            });
        }

        function filtrarVeiculos() {
            const filtro = document.getElementById("filtroVeiculo").value.toLowerCase();
            const veiculosFiltrados = todosVeiculos.filter(veiculo => {
                const nome = (veiculo.name || veiculo.veiculo_modelo || "").toLowerCase();
                const placa = (veiculo.placa || "").toLowerCase();
                const cliente = (veiculo.cliente || "").toLowerCase();
                return nome.includes(filtro) || placa.includes(filtro) || cliente.includes(filtro);
            });
            preencherDropdownVeiculos(veiculosFiltrados);
        }

        function preencherDadosVeiculo() {
            const selectVeiculo = document.getElementById("veiculoAPI");
            const selectedOption = selectVeiculo.options[selectVeiculo.selectedIndex];
            if (!selectedOption.value) return;

            const veiculo = JSON.parse(selectedOption.dataset.dados);

            const nomeNormalizado = normalizarNome(veiculo.cliente || "");
            document.getElementById("cliente").value = nomeNormalizado;
            document.getElementById("modelo").value = veiculo.veiculo_modelo || veiculo.name || "";
            document.getElementById("ano").value = "";
            document.getElementById("placa").value = veiculo.placa || "";
            document.getElementById("tipoEndereco").value = "link";
            document.getElementById("campoLink").style.display = "flex";
            document.getElementById("campoEndereco").style.display = "none";

            const localizacao = obterLocalizacao(veiculo);
            document.getElementById("linkLocalizacao").value = localizacao;
        }

        function adicionarServico() {
            let tipoServico = document.getElementById("tipoServico").value;
            let empresa = document.getElementById("empresa").value;
            let data = document.getElementById("data").value;
            let horario = document.getElementById("horario").value;
            let tecnico = document.getElementById("tecnico").value;
            let status = document.getElementById("status").value;
            let cliente = document.getElementById("cliente").value.trim();
            let telefone = document.getElementById("telefone").value;
            let tipoEndereco = document.getElementById("tipoEndereco").value;
            let modelo = document.getElementById("modelo").value;
            let ano = document.getElementById("ano").value;
            let placa = document.getElementById("placa").value;
            let observacoes = document.getElementById("observacoes").value;
            let valorReceber = document.getElementById("valorReceber").value;
            let eqp_id = document.getElementById("veiculoAPI").value || null;

            let rua = document.getElementById("rua")?.value.trim() || "";
            let numero = document.getElementById("numero")?.value.trim() || "";
            let bairro = document.getElementById("bairro")?.value.trim() || "";
            let cidade = document.getElementById("cidade")?.value.trim() || "";
            let ehCondominio = document.getElementById("ehCondominio")?.value || "";
            let bloco = document.getElementById("bloco")?.value.trim() || "";
            let apartamento = document.getElementById("apartamento")?.value.trim() || "";
            let linkLocalizacao = document.getElementById("linkLocalizacao").value.trim() || "";

            let nomeValido = /^[A-Za-zÀ-Ú][A-Za-zÀ-Ú\s]*(?:\s[A-Za-zÀ-Ú][A-Za-zÀ-Ú\s]*)+$/;

            if (!tipoServico || !empresa || !data || !horario || !tecnico || !cliente || !telefone || !modelo || !ano || !observacoes || !valorReceber) {
                alert("Preencha todos os campos obrigatórios!");
                return;
            }

            if (!nomeValido.test(cliente)) {
                alert("Por favor, insira um Nome e Sobrenome válidos. Exemplo: 'Rithelly Santos'");
                return;
            }

            if (tipoEndereco === "digitado") {
                if (!rua || !numero || !bairro || !cidade) {
                    alert("Preencha Rua, Número, Bairro e Cidade corretamente.");
                    return;
                }
                if (ehCondominio === "sim" && (!bloco || !apartamento)) {
                    alert("Se for condomínio, preencha Bloco e Apartamento.");
                    return;
                }
            } else if (tipoEndereco === "link") {
                if (!linkLocalizacao || linkLocalizacao === "Localização indisponível (equipamento não ativo ou GPS não fixado)") {
                    alert("Por favor, insira uma localização válida ou use o endereço digitado.");
                    return;
                }
            } else {
                alert("Selecione um tipo de endereço válido.");
                return;
            }

            let servicos = JSON.parse(localStorage.getItem("servicos") || "[]");
            if (servicos.some((s, i) => s.tecnico === tecnico && s.data === data && s.horario === horario && i !== editIndex)) {
                alert("Este técnico já tem um serviço agendado para este horário!");
                return;
            }

            let servico = {
                tipoServico, empresa, data, horario, tecnico, status, cliente, telefone,
                tipoEndereco, modelo, ano, placa, observacoes, valorReceber,
                endereco: tipoEndereco === "digitado" ? { rua, numero, bairro, cidade, ehCondominio, bloco, apartamento } : { linkLocalizacao },
                eqp_id
            };

            if (editIndex !== null) {
                servicos[editIndex] = servico;
                editIndex = null;
                document.getElementById("tituloAgenda").textContent = "Adicionar Novo Serviço";
                document.getElementById("botaoAcao").textContent = "Adicionar Serviço";
                document.getElementById("botaoAcao").onclick = adicionarServico;
            } else {
                servicos.push(servico);
            }

            localStorage.setItem("servicos", JSON.stringify(servicos));
            limparFormulario();
            atualizarListaServicos();
            atualizarServicosAtivos();
            mostrarAba("ativos");
            alert(editIndex === null ? "Serviço adicionado com sucesso!" : "Serviço atualizado com sucesso!");
        }

        function limparFormulario() {
            document.getElementById("filtroVeiculo").value = "";
            document.getElementById("veiculoAPI").value = "";
            document.getElementById("tipoServico").value = "";
            document.getElementById("empresa").value = "";
            document.getElementById("data").value = "";
            document.getElementById("horario").value = "";
            document.getElementById("tecnico").value = "";
            document.getElementById("status").value = "Pendente";
            document.getElementById("cliente").value = "";
            document.getElementById("telefone").value = "";
            document.getElementById("tipoEndereco").value = "";
            document.getElementById("modelo").value = "";
            document.getElementById("ano").value = "";
            document.getElementById("placa").value = "";
            document.getElementById("observacoes").value = "";
            document.getElementById("valorReceber").value = "";
            document.getElementById("rua").value = "";
            document.getElementById("numero").value = "";
            document.getElementById("bairro").value = "";
            document.getElementById("cidade").value = "";
            document.getElementById("ehCondominio").value = "";
            document.getElementById("bloco").value = "";
            document.getElementById("apartamento").value = "";
            document.getElementById("linkLocalizacao").value = "";
            document.getElementById("campoEndereco").style.display = "none";
            document.getElementById("campoLink").style.display = "none";
            document.getElementById("campoCondominio").style.display = "none";
            preencherDropdownVeiculos([]);
        }

        function formatarTelefone(campo) {
            let numero = campo.value.replace(/\D/g, "");
            if (numero.length > 11) numero = numero.slice(0, 11);

            if (numero.length > 10) {
                campo.value = "(" + numero.substring(0, 2) + ") " + numero.substring(2, 7) + "-" + numero.substring(7, 11);
            } else if (numero.length > 6) {
                campo.value = "(" + numero.substring(0, 2) + ") " + numero.substring(2, 6) + "-" + numero.substring(6);
            } else if (numero.length > 2) {
                campo.value = "(" + numero.substring(0, 2) + ") " + numero.substring(2);
            } else if (numero.length > 0) {
                campo.value = "(" + numero;
            }
        }

        function toggleCondominio() {
            let ehCondominio = document.getElementById("ehCondominio").value;
            let campoCondominio = document.getElementById("campoCondominio");
            campoCondominio.style.display = ehCondominio === "sim" ? "flex" : "none";
        }

        function alternarEndereco() {
            let tipoEndereco = document.getElementById("tipoEndereco").value;
            let campoEndereco = document.getElementById("campoEndereco");
            let campoLink = document.getElementById("campoLink");
            let campoCondominio = document.getElementById("campoCondominio");

            if (tipoEndereco === "digitado") {
                campoEndereco.style.display = "block";
                campoLink.style.display = "none";
            } else if (tipoEndereco === "link") {
                campoEndereco.style.display = "none";
                campoCondominio.style.display = "none";
                campoLink.style.display = "flex";
            } else {
                campoEndereco.style.display = "none";
                campoLink.style.display = "none";
                campoCondominio.style.display = "none";
            }
        }

        function validarLink() {
            let campoLink = document.getElementById("linkLocalizacao");
            let link = campoLink.value.trim();
            let regexLink = /^(https?:\/\/)?(www\.)?(google\.com\/maps|goo\.gl\/maps|waze\.com|maps\.apple\.com)\/.+$/;

            if (link && !regexLink.test(link) && link !== "Localização indisponível (equipamento não ativo ou GPS não fixado)") {
                alert("Por favor, insira um link válido do Google Maps, Waze ou Apple Maps.");
                campoLink.value = "";
                campoLink.focus();
            }
        }

        function mostrarAba(aba) {
            let abas = document.querySelectorAll(".tab");
            abas.forEach(tab => tab.classList.remove("active"));
            document.querySelector(`[onclick="mostrarAba('${aba}')"]`).classList.add("active");

            document.querySelectorAll(".aba").forEach(div => div.style.display = "none");
            document.getElementById(aba).style.display = "block";

            if (aba === "ativos") atualizarServicosAtivos();
            if (aba === "realizados") aplicarFiltros();
        }

        function formatarData(data) {
            let [ano, mes, dia] = data.split("-");
            return `${dia}/${mes}/${ano}`;
        }

        function atualizarListaServicos(filtros = {}) {
            let listaServicos = document.getElementById("listaServicos");
            let servicos = JSON.parse(localStorage.getItem("servicos") || "[]");

            let servicosFiltrados = servicos.filter(servico => {
                return (
                    (!filtros.tecnico || servico.tecnico === filtros.tecnico) &&
                    (!filtros.data || servico.data === filtros.data) &&
                    (!filtros.tipoServico || servico.tipoServico === filtros.tipoServico) &&
                    (!filtros.status || servico.status === filtros.status) &&
                    (!filtros.cliente || servico.cliente.toLowerCase().includes(filtros.cliente.toLowerCase()))
                );
            });

            servicosFiltrados.sort((a, b) => {
                let dataA = new Date(a.data + "T" + a.horario);
                let dataB = new Date(b.data + "T" + b.horario);
                return dataA - dataB;
            });

            let tecnicos = ["Bruno", "Cleber", "Romario"];
            listaServicos.innerHTML = "";

            tecnicos.forEach(tecnico => {
                let servicosTecnico = servicosFiltrados.filter(s => s.tecnico === tecnico);
                if (servicosTecnico.length > 0) {
                    let section = document.createElement("div");
                    section.className = "tecnico-section";
                    section.innerHTML = `<h3>${tecnico} (${servicosTecnico.length} serviços)</h3>`;

                    servicosTecnico.forEach((servico, index) => {
                        let div = document.createElement("div");
                        div.className = `servico-item ${servico.data === dataAtual ? 'hoje' : ''}`;
                        div.innerHTML = `
                            <strong>Serviço #${index + 1}</strong><br>
                            Tipo: ${servico.tipoServico}<br>
                            Empresa: ${servico.empresa}<br>
                            Data: ${formatarData(servico.data)} às ${servico.horario}<br>
                            Status: ${servico.status}<br>
                            Cliente: ${servico.cliente} - ${servico.telefone}<br>
                            Endereço: ${servico.tipoEndereco === "digitado" 
                                ? `${servico.endereco.rua}, ${servico.endereco.numero}, ${servico.endereco.bairro}, ${servico.endereco.cidade}` 
                                : `<a href="${servico.endereco.linkLocalizacao}" target="_blank" class="localizacao">${servico.endereco.linkLocalizacao}</a>`}<br>
                            Veículo: ${servico.modelo} (${servico.ano}) ${servico.placa ? "- " + servico.placa : ""}<br>
                            Observações: ${servico.observacoes}<br>
                            Valor: R$ ${servico.valorReceber}
                            <div class="buttons">
                                <button class="edit-button" onclick="editarServico(${servicos.indexOf(servico)})">Editar</button>
                                <button class="remove-button" onclick="removerServico(${servicos.indexOf(servico)})">Remover</button>
                            </div>
                        `;
                        section.appendChild(div);
                    });

                    listaServicos.appendChild(section);
                }
            });
        }

        async function atualizarServicosAtivos() {
    let listaServicosAtivos = document.getElementById("listaServicosAtivos");

    try {
        // Faz uma requisição ao servidor para pegar os agendamentos
        let response = await fetch("https://agendagrupojccar.com.br/api/get_agendamentos");
        let servicos = await response.json();

        let dataAtual = new Date().toISOString().split("T")[0]; // Obtém a data de hoje no formato YYYY-MM-DD

        let servicosAtivos = servicos.filter(servico => 
            (servico.status === "Pendente" || servico.status === "Concluído") && servico.data === dataAtual
        );

        listaServicosAtivos.innerHTML = ""; // Limpa a lista antes de atualizar

        servicosAtivos.forEach((servico, index) => {
            let div = document.createElement("div");
            div.className = `servico-item ${servico.data === dataAtual ? 'hoje' : ''}`;
            div.innerHTML = `
                <strong>Serviço #${index + 1}</strong><br>
                Tipo: ${servico.tipoServico}<br>
                Empresa: ${servico.empresa}<br>
                Data: ${formatarData(servico.data)} às ${servico.horario}<br>
                Status: ${servico.status}<br>
                Cliente: ${servico.cliente} - ${servico.telefone}<br>
                Endereço: ${servico.tipoEndereco === "digitado" 
                    ? `${servico.endereco.rua}, ${servico.endereco.numero}, ${servico.endereco.bairro}, ${servico.endereco.cidade}` 
                    : `<a href="${servico.endereco.linkLocalizacao}" target="_blank" class="localizacao">${servico.endereco.linkLocalizacao}</a>`}<br>
                Veículo: ${servico.modelo} (${servico.ano}) ${servico.placa ? "- " + servico.placa : ""}<br>
                Observações: ${servico.observacoes}<br>
                Valor: R$ ${servico.valorReceber}
                <div class="buttons">
                    <select onchange="atualizarStatus(${index}, this.value)">
                        <option value="Pendente" ${servico.status === "Pendente" ? "selected" : ""}>Pendente</option>
                        <option value="Concluído" ${servico.status === "Concluído" ? "selected" : ""}>Concluído</option>
                        <option value="Cancelado" ${servico.status === "Cancelado" ? "selected" : ""}>Cancelado</option>
                    </select>
                </div>
            `;
            listaServicosAtivos.appendChild(div);
        });

    } catch (error) {
        console.error("Erro ao carregar serviços:", error);
    }
}

        function atualizarStatus(index, novoStatus) {
            let servicos = JSON.parse(localStorage.getItem("servicos") || "[]");
            servicos[index].status = novoStatus;
            localStorage.setItem("servicos", JSON.stringify(servicos));
            atualizarServicosAtivos();
            atualizarListaServicos();
            alert("Status atualizado para: " + novoStatus);
        }

        function aplicarFiltros() {
            let filtros = {
                tecnico: document.getElementById("filtroTecnico").value,
                data: document.getElementById("filtroData").value,
                tipoServico: document.getElementById("filtroTipoServico").value,
                status: document.getElementById("filtroStatus").value,
                cliente: document.getElementById("filtroCliente").value
            };
            atualizarListaServicos(filtros);
        }

        function limparFiltros() {
            document.getElementById("filtroTecnico").value = "";
            document.getElementById("filtroData").value = "";
            document.getElementById("filtroTipoServico").value = "";
            document.getElementById("filtroStatus").value = "";
            document.getElementById("filtroCliente").value = "";
            atualizarListaServicos();
        }

        function removerServico(index) {
            if (confirm("Tem certeza que deseja remover este serviço?")) {
                let servicos = JSON.parse(localStorage.getItem("servicos") || "[]");
                servicos.splice(index, 1);
                localStorage.setItem("servicos", JSON.stringify(servicos));
                aplicarFiltros();
                atualizarServicosAtivos();
            }
        }

        function editarServico(index) {
            let servicos = JSON.parse(localStorage.getItem("servicos") || "[]");
            let servico = servicos[index];

            document.getElementById("filtroVeiculo").value = "";
            document.getElementById("veiculoAPI").value = servico.eqp_id || "";
            document.getElementById("tipoServico").value = servico.tipoServico;
            document.getElementById("empresa").value = servico.empresa;
            document.getElementById("data").value = servico.data;
            document.getElementById("horario").value = servico.horario;
            document.getElementById("tecnico").value = servico.tecnico;
            document.getElementById("status").value = servico.status;
            document.getElementById("cliente").value = servico.cliente;
            document.getElementById("telefone").value = servico.telefone;
            document.getElementById("tipoEndereco").value = servico.tipoEndereco;
            document.getElementById("modelo").value = servico.modelo;
            document.getElementById("ano").value = servico.ano;
            document.getElementById("placa").value = servico.placa;
            document.getElementById("observacoes").value = servico.observacoes;
            document.getElementById("valorReceber").value = servico.valorReceber;

            if (servico.tipoEndereco === "digitado") {
                document.getElementById("campoEndereco").style.display = "block";
                document.getElementById("rua").value = servico.endereco.rua;
                document.getElementById("numero").value = servico.endereco.numero;
                document.getElementById("bairro").value = servico.endereco.bairro;
                document.getElementById("cidade").value = servico.endereco.cidade;
                document.getElementById("ehCondominio").value = servico.endereco.ehCondominio;
                if (servico.endereco.ehCondominio === "sim") {
                    document.getElementById("campoCondominio").style.display = "flex";
                    document.getElementById("bloco").value = servico.endereco.bloco;
                    document.getElementById("apartamento").value = servico.endereco.apartamento;
                }
            } else if (servico.tipoEndereco === "link") {
                document.getElementById("campoLink").style.display = "flex";
                document.getElementById("linkLocalizacao").value = servico.endereco.linkLocalizacao;
            }

            document.getElementById("tituloAgenda").textContent = "Editar Serviço";
            document.getElementById("botaoAcao").textContent = "Salvar Alterações";
            document.getElementById("botaoAcao").onclick = adicionarServico;
            editIndex = index;

            carregarVeiculosPorBase();
            mostrarAba("agenda");
        }

        function iniciarAtualizacaoAutomatica() {
            if (!intervalId) {
                intervalId = setInterval(() => {
                    if (document.getElementById("ativos").style.display !== "none") {
                        atualizarServicosAtivos();
                    }
                }, 30000); // Atualiza a cada 30 segundos
            }
        }

        function pararAtualizacaoAutomatica() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        window.onload = function () {
            document.getElementById("campoEndereco").style.display = "none";
            document.getElementById("campoCondominio").style.display = "none";
            document.getElementById("campoLink").style.display = "none";
            atualizarListaServicos();
            iniciarAtualizacaoAutomatica();

            window.addEventListener("beforeunload", pararAtualizacaoAutomatica);
        };

	setInterval(atualizarServicosAtivos, 5000); // Atualiza os serviços a cada 5 segundos

function logout() {
    if (confirm("Tem certeza que deseja sair?")) {
        window.location.href = "login.html"; // Substitua pelo caminho correto
    }
}
    </script>
</body>
</html>